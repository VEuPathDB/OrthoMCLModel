<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>

    <!-- *************** -->
    <!-- model querySets -->
    <!-- *************** -->

    <!--
    A "query" obtains tabular values from a data source.  It has columns
    and parameters.  So far, only SQL data sources are supported, but others,
    such as flat files are coming.  

    Queries are used for different purposes: providing primary keys to a 
    question; providing attributes and tables to a record; and, providing
    vocabularies to vocabulary parameters.

    A "query set" is a grouping of queries.  It is useful in organizing the
    model xml file.  

    The full name of a query is of the form "set_name.name."
    -->

    <!-- Queries that retrieve attributes of ESTs -->
    
    <querySet name="SequenceAttributes" queryType="attribute" isCacheable="false">

       <defaultTestParamValues>
            <paramValue name="full_id">pfal|PF11_0344</paramValue>
       </defaultTestParamValues>

        <testRowCountSql>
            SELECT count(*) FROM dots.aasequence aas, apidbTuning.SequenceAttributes sa
            WHERE aas.taxon_id in (select distinct(aas.taxon_id) from apidb.organism og, dots.aasequence aas where aas.taxon_id = og.taxon_id)
	    AND aas.aa_sequence_id = sa.aa_sequence_id
         </testRowCountSql>


        <sqlQuery name="SequenceAttrs">
            <column name="full_id"/>
            <column name="source_id"/>
            <column name="length"/>
            <column name="product"/>
<!--
            <column name="molecular_weight"/>
-->
            <column name="abbreviation"/>
            <column name="taxon_name"/>          
            <column name="pfam_domains"/>          
            <sql>
		<![CDATA[
SELECT aas.source_id as full_id, sa.source_id,  
    sa.length as length, sa.product as product, 
    --round(sa.molecular_weight/1000,1) AS molecular_weight,
    sa.taxon_abbreviation AS abbreviation, 
    sa.organism_name AS taxon_name, 
    (SELECT string_agg(da.accession, ', ') 
     FROM ApidbTuning.DomainAssignment da 
     WHERE da.aa_sequence_id = sa.aa_sequence_id 
     GROUP BY da.full_id) AS pfam_domains
FROM apidbTuning.SequenceAttributes sa
FULL OUTER JOIN dots.aasequence aas ON aas.source_id = sa.full_id
WHERE aas.taxon_id in (select distinct(aas.taxon_id) from apidb.organism og, dots.aasequence aas where aas.taxon_id = og.taxon_id)
AND aas.source_id = sa.full_id
 		]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ECNumbersAttr">
           <column name="full_id"/>
           <column name="ec_numbers"/>          
           <sql>
             <![CDATA[
SELECT sa.full_id, ec.ec_numbers
FROM apidbtuning.sequenceattributes sa
LEFT JOIN (
    SELECT full_id, string_agg(sec.ec_number, ', ' ORDER BY sec.ec_number) AS ec_numbers
    FROM apidbtuning.sequenceenzymeclass sec
    GROUP BY full_id
) ec ON sa.full_id = ec.full_id
LEFT JOIN dots.aasequence aas 
    ON aas.source_id = sa.full_id
   AND aas.taxon_id IN (
       SELECT DISTINCT og.taxon_id
       FROM apidb.organism og
       JOIN dots.aasequence aas2 ON aas2.taxon_id = og.taxon_id
   )
             ]]>
           </sql>
        </sqlQuery>

        <sqlQuery name="SequenceGroup">
           <column name="full_id"/>
           <column name="core_peripheral"/>
           <column name="group_name"/>
           <column name="num_core"/>
           <column name="num_peripheral"/>
<!-- TODO??
           <column name="source_url"/>
           <column name="source_text"/>
           <column name="old_groups"/>
-->
            <sql>
             <![CDATA[
SELECT sa.full_id as full_id, 
       sa.group_name as group_name,
       CASE sa.core_peripheral 
           WHEN 'C' THEN 'Core' 
           WHEN 'P' THEN 'Peripheral' 
       END AS core_peripheral, 
       number_of_core_members AS num_core, 
       number_of_peripheral_members AS num_peripheral
       --sa.source_url, sa.source_text
FROM ApidbTuning.SequenceAttributes sa
             ]]>
           </sql>
        </sqlQuery>

        <sqlQuery name="SequenceSequence">
            <column name="full_id"/>
            <column name="sequence"/>
            <sql>
			<![CDATA[
SELECT aas.source_id AS full_id, aas.sequence
FROM dots.aasequence aas
 			]]>
            </sql>
        </sqlQuery>

    </querySet>

    <querySet name="SequenceTables" queryType="table" isCacheable="false">

        <sqlQuery name="OldGroups">
            <column name="full_id"/>
            <column name="group_name"/>
            <sql>
                        <![CDATA[
SELECT aas.source_id AS full_id, ref.primary_identifier AS group_name
FROM dots.aasequence aas
JOIN Dots.AaSequenceDbRef seqref ON aas.aa_sequence_id = seqref.aa_sequence_id
JOIN Sres.DbRef ref ON seqref.db_ref_id = ref.db_ref_id
JOIN Sres.ExternalDatabaseRelease dbr ON ref.external_database_release_id = dbr.external_database_release_id
JOIN Sres.ExternalDatabase db ON dbr.external_database_id = db.external_database_id
WHERE db.name = 'OrthoMCL Old Groups'
                        ]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="PFamDomains">
            <column name="full_id"/>
            <column name="accession"/>
<!--
            <column name="symbol"/>
-->
            <column name="description"/>
            <column name="domain_index"/>
            <column name="max_index"/>
            <column name="start_min"/>
            <column name="end_max"/>
            <column name="length"/>
            <sql>
                        <![CDATA[
SELECT da.full_id as full_id, da.accession as accession, da.description as description, da.domain_index as domain_index,
       (SELECT MAX(domain_index) FROM ApidbTuning.DomainAssignment) AS max_index,
       da.start_min as start_min, da.end_max as end_max, sa.length as length
FROM ApidbTuning.DomainAssignment da
JOIN ApidbTuning.SequenceAttributes sa ON da.full_id = sa.full_id
ORDER BY da.full_id, da.start_min
            ]]>
          </sql>
        </sqlQuery>


        <sqlQuery name="EcNumbers">
            <column name="full_id"/>
            <column name="ec_number"/>
            <column name="description"/>
            <column name="expasy_url"/>
            <sql>
                <![CDATA[
SELECT sec.full_id as full_id, sec.ec_number, sec.description,
       'http://enzyme.expasy.org/cgi-bin/enzyme/enzyme-search-ec?field1=' || sec.ec_number_1
       || '&field2=' || sec.ec_number_2
       || '&field3=' || sec.ec_number_3
       || '&field4=' || sec.ec_number_4 AS expasy_url
FROM apidbtuning.sequenceenzymeclass sec
 		]]>
            </sql>
        </sqlQuery>

        <!-- tables for text search -->

        <sqlQuery name="Product">
            <column name="full_id"/>
            <column name="product"/>
            <column name="id_string"/>
            <sql>
		<![CDATA[
SELECT aas.source_id AS full_id,
       aas.description AS product,
       aas.source_id AS id_string
FROM dots.aasequence aas
 		]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="Taxon">
            <column name="full_id"/>
            <column name="taxon"/>
            <column name="abbreviation"/>
            <sql>
		<![CDATA[
                  SELECT full_id as full_id, taxon_abbreviation AS abbreviation, organism_name AS taxon
                  FROM apidbtuning.sequenceattributes
 		]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="OrthologGroupId">
            <column name="full_id"/>
            <column name="group_name"/>
            <sql>
                <![CDATA[
WITH sequences AS (
    SELECT full_id, group_name, aa_sequence_id
    FROM ApidbTuning.SequenceAttributes
)
SELECT s.full_id, s.group_name
FROM sequences s
WHERE s.group_name IS NOT NULL

UNION

SELECT s.full_id, ref.primary_identifier AS group_name
FROM sequences s
JOIN dots.AaSequenceDbRef seqref ON s.aa_sequence_id = seqref.aa_sequence_id
JOIN Sres.DbRef ref ON seqref.db_ref_id = ref.db_ref_id
JOIN Sres.ExternalDatabase db ON ref.external_database_release_id = db.external_database_id
JOIN Sres.ExternalDatabaseRelease dbr ON dbr.external_database_release_id = ref.external_database_release_id
WHERE db.name = 'OrthoMCL Old Groups'
 		]]>
            </sql>
        </sqlQuery>

    </querySet>

</wdkModel>
