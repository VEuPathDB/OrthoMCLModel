<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>

    <!-- *************** -->
    <!-- model querySets -->
    <!-- *************** -->

    <!--
    A "query" obtains tabular values from a data source.  It has columns
    and parameters.  So far, only SQL data sources are supported, but others,
    such as flat files are coming.  

    Queries are used for different purposes: providing primary keys to a 
    question; providing attributes and tables to a record; and, providing
    vocabularies to vocabulary parameters.

    A "query set" is a grouping of queries.  It is useful in organizing the
    model xml file.  

    The full name of a query is of the form "set_name.name."
    -->

    <!-- Queries that retrieve attributes of ESTs -->

    <querySet name="HelperAttributes" queryType="attribute"  isCacheable="false">

        <sqlQuery name="Counts" isCacheable="true">
            <column name="helper_id"/>
            <column name="organism_count"/>
            <column name="protein_count"/>
            <column name="group_count"/>
            <sql>
            <![CDATA[
SELECT 
    'helper' AS helper_id, 
    organism_count, 
    protein_count, 
    group_count
FROM
    (SELECT count(organism_id) AS organism_count
     FROM apidb.Organism) AS organism_count_query,
    (SELECT count(ogas.ortholog_group_aa_sequence_id) AS protein_count
     FROM APIDB.orthologgroupaasequence ogas
     JOIN APIDB.orthologgroup og ON ogas.ortholog_group_aa_sequence_id = og.ortholog_group_id) AS protein_count_query,
    (SELECT count(ortholog_group_id) AS group_count
     FROM APIDB.orthologgroup) AS group_count_query
            ]]>
            </sql>
        </sqlQuery>

    </querySet>
    
    <querySet name="HelperTables" queryType="table"  isCacheable="false">

       <defaultTestParamValues>
            <paramValue name="helper_id">helper</paramValue>
       </defaultTestParamValues>

        <sqlQuery name="Taxons" isCacheable="true">
            <column name="helper_id"/>
            <column name="taxon_id"/>
            <column name="parent_id"/>
            <column name="abbreviation"/>
            <column name="is_species"/>
            <column name="sort_index"/>
            <column name="common_name"/>
            <column name="name"/>
            <sql>
            <![CDATA[
WITH RECURSIVE TaxonHierarchy AS (
  -- Base case
  SELECT
    three_letter_abbrev,
    orthomcl_clade_id,
    name,
    core_peripheral,
    name AS taxon_group,
    parent_id
  FROM apidb.OrthomclClade
  WHERE name IN ('Archaea', 'Bacteria', 'Alveolates', 'Amoebozoa', 'Euglenozoa',
                 'Fungi', 'Metazoa', 'Other Eukaryota', 'Viridiplantae')

  UNION ALL

  -- Recursive case
  SELECT
    child.three_letter_abbrev,
    child.orthomcl_clade_id,
    child.name,
    child.core_peripheral,
    parent.taxon_group,
    child.parent_id
  FROM apidb.OrthomclClade child
  JOIN TaxonHierarchy parent ON child.parent_id = parent.orthomcl_clade_id
) 

SELECT 
    'helper' AS helper_id,
    og.taxon_id AS taxon_id,
    og.taxon_id AS parent_id,
    og.orthomcl_abbrev AS abbreviation,
    1 as is_species,
    og.name_for_filenames as name,
    og.name_for_filenames as common_name,
    cats.taxon_group,
    ROW_NUMBER() OVER (ORDER BY cats.taxon_group NULLS FIRST, og.name_for_filenames) AS sort_index
FROM apidb.Organism og
LEFT JOIN taxonHierarchy cats ON og.orthomcl_abbrev = cats.three_letter_abbrev
ORDER BY cats.taxon_group NULLS FIRST, og.name_for_filenames
			]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="DataSummary" isCacheable="true">
            <column name="helper_id"/>
            <column name="name"/>
            <column name="core_peripheral"/>
            <column name="three_letter_abbrev"/>
            <column name="resource_name"/>
            <column name="resource_url"/>
            <column name="resource_version"/>
            <column name="ncbi_taxon_id"/>
            <column name="ncbi_taxon_url"/>
            <column name="sequences"/>
            <column name="clustered_sequences"/>
            <column name="groups"/>
            <column name="most_recent"/>
            <sql>
            <![CDATA[
SELECT
  'helper' AS helper_id,
  og.name_for_filenames AS name,
  og.orthomcl_abbrev AS three_letter_abbrev,

  CASE
    WHEN od.resource_url = '-' THEN '-'
    ELSE od.resource_name
  END AS resource_name,

  od.resource_url AS resource_url,
  od.resource_version AS resource_version,

  CASE
    WHEN og.core_peripheral = 'core' THEN 'Core'
    WHEN og.core_peripheral = 'peripheral' THEN 'Peripheral'
    ELSE ''
  END AS core_peripheral,

  CASE
    WHEN SUBSTRING(og.orthomcl_abbrev FROM 5 FOR 4) = '-old' THEN 'no'
    ELSE 'most_recent'
  END AS most_recent,

  t.ncbi_tax_id AS ncbi_taxon_id,
  'https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?id=' || t.ncbi_tax_id AS ncbi_taxon_url,

  stats.sequences,
  stats.clustered_sequences,
  stats.groups

FROM apidb.Organism og

LEFT JOIN apidb.OrthomclResource od
  ON od.orthomcl_taxon_id = og.taxon_id

LEFT JOIN sres.TaxonName tn
  ON og.taxon_id = tn.taxon_id

LEFT JOIN sres.Taxon t
  ON t.taxon_id = tn.taxon_id

LEFT JOIN (
  SELECT
    orthomcl_taxon_id,
    COUNT(*) AS sequences,
    SUM(CASE WHEN ortholog_group_id IS NULL THEN 0 ELSE 1 END) AS clustered_sequences,
    COUNT(DISTINCT ortholog_group_id) AS groups
  FROM ApidbTuning.SequenceAttributes
  GROUP BY orthomcl_taxon_id
) stats
  ON og.taxon_id = stats.orthomcl_taxon_id

WHERE stats.clustered_sequences IS NOT NULL
  AND od.resource_url IS NOT NULL

ORDER BY og.name_for_filenames

            ]]>
            </sql>
        </sqlQuery>


       <sqlQuery name="RootTaxons" isCacheable="true">
           <column name="helper_id"/>
           <column name="taxon_abbrev"/>
           <column name="color"/>
           <sql>
           <![CDATA[
SELECT 'helper' AS helper_id, t.*
FROM (
    SELECT 'OBAC' AS taxon_abbrev, '#9999CC' AS color
    UNION ALL
    SELECT 'FIRM' AS taxon_abbrev, '#33CC99' AS color
    UNION ALL
    SELECT 'PROT' AS taxon_abbrev, '#99CC66' AS color
    UNION ALL
    SELECT 'ARCH' AS taxon_abbrev, '#77CCDD' AS color
    UNION ALL
    SELECT 'OEUK' AS taxon_abbrev, '#CC9999' AS color
    UNION ALL
    SELECT 'VIRI' AS taxon_abbrev, '#CC9933' AS color
    UNION ALL
    SELECT 'EUGL' AS taxon_abbrev, '#CCCC66' AS color
    UNION ALL
    SELECT 'ALVE' AS taxon_abbrev, '#CC3399' AS color
    UNION ALL
    SELECT 'FUNG' AS taxon_abbrev, '#AA44DD' AS color
    UNION ALL
    SELECT 'META' AS taxon_abbrev, '#CC6666' AS color
    UNION ALL
    SELECT 'AMOE' AS taxon_abbrev, '#3399CC' AS color
) t
           ]]>
           </sql>
       </sqlQuery>

    </querySet>

</wdkModel>
