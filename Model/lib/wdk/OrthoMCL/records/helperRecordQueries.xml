<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>

    <!-- *************** -->
    <!-- model querySets -->
    <!-- *************** -->

    <!--
    A "query" obtains tabular values from a data source.  It has columns
    and parameters.  So far, only SQL data sources are supported, but others,
    such as flat files are coming.  

    Queries are used for different purposes: providing primary keys to a 
    question; providing attributes and tables to a record; and, providing
    vocabularies to vocabulary parameters.

    A "query set" is a grouping of queries.  It is useful in organizing the
    model xml file.  

    The full name of a query is of the form "set_name.name."
    -->

    <!-- Queries that retrieve attributes of ESTs -->

    <querySet name="HelperAttributes" queryType="attribute"  isCacheable="false">

        <sqlQuery name="Counts" isCacheable="true">
            <column name="helper_id"/>
            <column name="organism_count"/>
            <column name="protein_count"/>
            <column name="group_count"/>
            <sql>
            <![CDATA[
SELECT 
    'helper' AS helper_id, 
    organism_count, 
    protein_count, 
    group_count
FROM
    (SELECT count(organism_id) AS organism_count
     FROM apidb.Organism) AS organism_count_query,
    (SELECT count(ogas.ortholog_group_aa_sequence_id) AS protein_count
     FROM APIDB.orthologgroupaasequence ogas
     JOIN APIDB.orthologgroup og ON ogas.ortholog_group_aa_sequence_id = og.ortholog_group_id) AS protein_count_query,
    (SELECT count(ortholog_group_id) AS group_count
     FROM APIDB.orthologgroup) AS group_count_query
            ]]>
            </sql>
        </sqlQuery>

    </querySet>
    
    <querySet name="HelperTables" queryType="table"  isCacheable="false">

       <defaultTestParamValues>
            <paramValue name="helper_id">helper</paramValue>
       </defaultTestParamValues>

       <sqlQuery name="Taxons" isCacheable="true">
            <column name="helper_id"/>
            <column name="orthomcl_clade_id"/>
            <column name="taxon_group"/>
            <column name="parent_id"/>
            <column name="three_letter_abbrev"/>
            <column name="name"/>
            <column name="color"/>
            <column name="core_peripheral"/>
            <sql>
            <![CDATA[
WITH RECURSIVE

TaxonColors AS (
  SELECT *
  FROM (
    VALUES
      ('Archaea',           '#77CCDD'),
      ('Bacteria',          '#99CC33'),
      ('Alveolates',        '#CC3399'),
      ('Amoebozoa',         '#3399CC'),
      ('Euglenozoa',        '#CCCC66'),
      ('Fungi',             '#AA44DD'),
      ('Metazoa',           '#CC6666'),
      ('Other Eukaryota',   '#CC9999'),
      ('Viridiplantae',     '#CC9933')
  ) AS t(taxon_group, color)
),

TaxonHierarchy AS (
  -- Base case
  SELECT
    three_letter_abbrev,
    orthomcl_clade_id,
    name,
    core_peripheral,
    name AS taxon_group,
    parent_id
  FROM apidb.OrthomclClade
  WHERE name IN (select name from apidb.orthomclClade where is_species = 0)
  
  UNION ALL

  -- Recursive case
  SELECT
    child.three_letter_abbrev,
    child.orthomcl_clade_id,
    child.name,
    child.core_peripheral,
    parent.taxon_group,
    child.parent_id
  FROM apidb.OrthomclClade child
  JOIN TaxonHierarchy parent
    ON child.parent_id = parent.orthomcl_clade_id
),

ColorWalk AS (
  SELECT
    h.orthomcl_clade_id AS origin_clade_id,
    h.taxon_group,
    h.parent_id,
    tc.color
  FROM TaxonHierarchy h
  LEFT JOIN TaxonColors tc
    ON tc.taxon_group = h.taxon_group

  UNION ALL

  SELECT
    w.origin_clade_id,
    p.name AS taxon_group,
    p.parent_id,
    tc.color
  FROM ColorWalk w
  JOIN apidb.OrthomclClade p
    ON p.orthomcl_clade_id = w.parent_id
  LEFT JOIN TaxonColors tc
    ON tc.taxon_group = p.name
  WHERE w.color IS NULL
),

ResolvedColors AS (
  SELECT DISTINCT ON (origin_clade_id)
    origin_clade_id,
    color
  FROM ColorWalk
  WHERE color IS NOT NULL
  ORDER BY origin_clade_id
)

SELECT
  'helper' AS helper_id, 
  h.*,
  rc.color
FROM TaxonHierarchy h
LEFT JOIN ResolvedColors rc
  ON rc.origin_clade_id = h.orthomcl_clade_id
WHERE h.core_peripheral IN ('C', 'P')
  AND EXISTS (
    SELECT 1
    FROM apidb.organism o
    WHERE o.orthomcl_abbrev = h.three_letter_abbrev
      AND o.is_annotated_genome = 1
  )
ORDER BY h.taxon_group, h.name
]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="DataSummary" isCacheable="true">
            <column name="helper_id"/>
            <column name="name"/>
            <column name="core_peripheral"/>
            <column name="three_letter_abbrev"/>
            <column name="resource_name"/>
            <column name="resource_url"/>
            <column name="resource_version"/>
            <column name="ncbi_taxon_id"/>
            <column name="ncbi_taxon_url"/>
            <column name="sequences"/>
            <column name="clustered_sequences"/>
            <column name="groups"/>
            <column name="most_recent"/>
            <sql>
            <![CDATA[
SELECT
  'helper' AS helper_id,
  tn.name AS name,
  og.orthomcl_abbrev AS three_letter_abbrev,

  CASE
    WHEN od.resource_url = '-' THEN '-'
    ELSE od.resource_name
  END AS resource_name,

  od.resource_url AS resource_url,
  od.resource_version AS resource_version,

  CASE
    WHEN og.core_peripheral = 'core' THEN 'Core'
    WHEN og.core_peripheral = 'peripheral' THEN 'Peripheral'
    ELSE ''
  END AS core_peripheral,

  CASE
    WHEN SUBSTRING(og.orthomcl_abbrev FROM 5 FOR 4) = '-old' THEN 'no'
    ELSE 'most_recent'
  END AS most_recent,

  t.ncbi_tax_id AS ncbi_taxon_id,
  'https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?id=' || t.ncbi_tax_id AS ncbi_taxon_url,

  stats.sequences,
  stats.clustered_sequences,
  stats.groups

FROM apidb.Organism og

LEFT JOIN apidb.OrthomclResource od
  ON od.orthomcl_taxon_id = og.taxon_id

LEFT JOIN sres.TaxonName tn
  ON og.taxon_id = tn.taxon_id

LEFT JOIN sres.Taxon t
  ON t.taxon_id = tn.taxon_id

LEFT JOIN (
  SELECT
    orthomcl_taxon_id,
    COUNT(*) AS sequences,
    SUM(CASE WHEN ortholog_group_id IS NULL THEN 0 ELSE 1 END) AS clustered_sequences,
    COUNT(DISTINCT ortholog_group_id) AS groups
  FROM ApidbTuning.SequenceAttributes
  GROUP BY orthomcl_taxon_id
) stats
  ON og.taxon_id = stats.orthomcl_taxon_id

WHERE stats.clustered_sequences IS NOT NULL
  AND od.resource_url IS NOT NULL

ORDER BY tn.name

            ]]>
            </sql>
        </sqlQuery>


	<sqlQuery name="RootTaxons" isCacheable="true">
           <column name="helper_id"/>	  
           <column name="orthomcl_clade_id"/>
           <column name="parent_id"/>
           <column name="taxon_abbrev"/>
           <column name="color"/>
           <column name="name"/>
           <sql>
           <![CDATA[
WITH RECURSIVE

TaxonColors AS (
  SELECT *
  FROM (
    VALUES
      ('Archaea',           '#77CCDD'),
      ('Bacteria',          '#99CC33'),
      ('Alveolates',        '#CC3399'),
      ('Amoebozoa',         '#3399CC'),
      ('Euglenozoa',        '#CCCC66'),
      ('Fungi',             '#AA44DD'),
      ('Metazoa',           '#CC6666'),
      ('Other Eukaryota',   '#CC9999'),
      ('Viridiplantae',     '#CC9933')
  ) AS t(taxon_group, color)
),

AllClades AS (
  SELECT *
  FROM apidb.orthomclclade
  WHERE is_species = 0
),

ColoredHierarchy AS (
  -- Base case: nodes that have a top-level color
  SELECT
    c.orthomcl_clade_id,
    c.parent_id,
    c.name,
    c.three_letter_abbrev,
    c.name AS taxon_group,
    tc.color
  FROM AllClades c
  LEFT JOIN TaxonColors tc
    ON c.name = tc.taxon_group
  WHERE tc.color IS NOT NULL

  UNION ALL

  -- Recursive step: propagate color to children
  SELECT
    child.orthomcl_clade_id,
    child.parent_id,
    child.name,
    child.three_letter_abbrev,
    parent.taxon_group,
    parent.color
  FROM AllClades child
  JOIN ColoredHierarchy parent
    ON child.parent_id = parent.orthomcl_clade_id
)

SELECT
  'helper' AS helper_id, 
  c.orthomcl_clade_id,
  c.parent_id,
  c.name,
  c.three_letter_abbrev as taxon_abbrev,
  ch.color
FROM AllClades c
LEFT JOIN ColoredHierarchy ch
  ON c.orthomcl_clade_id = ch.orthomcl_clade_id
ORDER BY c.orthomcl_clade_id, c.name
           ]]>
           </sql>
       </sqlQuery>

    </querySet>

</wdkModel>
