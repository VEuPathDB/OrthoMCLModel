<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>

    <!-- *************** -->
    <!-- model querySets -->
    <!-- *************** -->

    <querySet name="GroupIds" queryType="id" isCacheable="false">

        <sqlQuery name="GroupAlias" isCacheable="true" doNotTest="true">
            <column name="group_name"/>
            <column name="old_group_name"/>
            <sql>
              <![CDATA[
               select og.NEW_GROUP_ID as group_name,
                      og.OLD_GROUP_ID as old_group_name
              from apidb.groupmapping og
              ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ByNameList" isCacheable="true">
            <paramRef ref="groupParams.group_names"/>
            <column name="group_name"/>
            <sql>
              <![CDATA[
SELECT og.group_id AS group_name
FROM apidb.OrthologGroup og
WHERE lower(og.group_id) IN (
    SELECT DISTINCT lower(gm.new_group_id) AS group_id
    FROM apidb.GroupMapping gm
    JOIN (
        $$group_names$$
    ) AS ds(group_name) ON lower(gm.old_group_id) = lower(ds.group_name)
)
	      ]]>
            </sql>
        </sqlQuery>  

        <sqlQuery name="ByPfamIdOrKeyword" 
			isCacheable="true" doNotTest="true">
       <paramRef ref="sharedParams.pfam_id_type_ahead"/>
       <paramRef ref="groupParams.min_num_proteins"/>
       <paramRef ref="groupParams.min_fraction_proteins"/>
       <column name="group_name"/>

       <sql>
            <![CDATA[
WITH group_counts AS (
    SELECT
        ogas.group_id,
        COUNT(*) AS number_of_members,
        COUNT(*) FILTER (WHERE og.core_peripheral = 'core') AS number_of_core_members,
        COUNT(*) FILTER (WHERE og.core_peripheral = 'peripheral') AS number_of_peripheral_members
    FROM
        apidb.orthologgroupaasequence AS ogas
        JOIN dots.aasequence AS das
          ON ogas.aa_sequence_id = das.aa_sequence_id
        JOIN apidb.organism AS og
          ON das.taxon_id = og.taxon_id
    GROUP BY
        ogas.group_id
),
domain AS (
    SELECT
        group_name,
        COUNT(DISTINCT full_id) AS num_proteins
    FROM
        ApidbTuning.DomainAssignment
    WHERE
        group_name IS NOT NULL
        AND (
            accession LIKE UPPER(REPLACE($$pfam_id_type_ahead$$, '*', '%'))
            OR description LIKE REPLACE($$pfam_id_type_ahead$$, '*', '%')
        )
    GROUP BY
        group_name
)
SELECT
    domain.group_name
FROM
    domain
    JOIN group_counts AS gc ON gc.group_id = domain.group_name
WHERE
    domain.num_proteins >= $$min_num_proteins$$
    AND (domain.num_proteins::numeric / gc.number_of_members) >= $$min_fraction_proteins$$

            ]]>
       </sql>
    </sqlQuery>

        <sqlQuery name="ByKeyword" isCacheable="true">
            <paramRef ref="sharedParams.keyword"/>
            <column name="group_name"/>
            <sql>
                <![CDATA[
SELECT DISTINCT sa.group_name
FROM ApidbTuning.SequenceAttributes sa
JOIN dots.AaSequenceImp asi ON sa.aa_sequence_id = asi.aa_sequence_id
WHERE asi.subclass_view = 'ExternalAASequence'
  AND POSITION($$keyword$$ IN asi.description) > 0
                ]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="BySequenceCount" isCacheable="true">
            <paramRef ref="groupParams.all_count"/>
            <paramRef ref="groupParams.core_count" groupRef="paramGroups.corePeripheralAdvancedParams"/>
            <paramRef ref="groupParams.peripheral_count" groupRef="paramGroups.corePeripheralAdvancedParams"/>
            <column name="group_name"/>
            <column name="core_num"/>
            <column name="peripheral_num"/>
            <sql>
                <![CDATA[
WITH group_counts AS (
    SELECT
        ogas.group_id,
        COUNT(*) AS number_of_members,
        COUNT(*) FILTER (WHERE og.core_peripheral = 'core') AS number_of_core_members,
        COUNT(*) FILTER (WHERE og.core_peripheral = 'peripheral') AS number_of_peripheral_members
    FROM
        apidb.orthologgroupaasequence AS ogas
        JOIN dots.aasequence AS das
            ON ogas.aa_sequence_id = das.aa_sequence_id
        JOIN apidb.organism AS og
            ON das.taxon_id = og.taxon_id
    GROUP BY
        ogas.group_id
)
SELECT
    gc.group_id AS group_name,
    gc.number_of_core_members AS core_num,
    gc.number_of_peripheral_members AS peripheral_num,
    gc.number_of_members AS total_num
FROM
    group_counts AS gc
WHERE
    gc.number_of_core_members BETWEEN $$core_count_min$$ AND $$core_count_max$$
    AND gc.number_of_peripheral_members BETWEEN $$peripheral_count_min$$ AND $$peripheral_count_max$$
    AND gc.number_of_members BETWEEN $$all_count_min$$ AND $$all_count_max$$
                ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ByGenomeCount" isCacheable="true">
            <paramRef ref="groupParams.all_taxon"/>
            <paramRef ref="groupParams.core_taxon" groupRef="paramGroups.corePeripheralAdvancedParams"/>
            <paramRef ref="groupParams.peripheral_taxon" groupRef="paramGroups.corePeripheralAdvancedParams"/>
            <column name="group_name"/>
            <column name="core_count"/>
            <column name="peripheral_count"/>
            <column name="all_count"/>
            <sql>
              <![CDATA[
SELECT
    group_name,
    core_count,
    peripheral_count,
    core_count + peripheral_count AS all_count
FROM (
    SELECT
        COALESCE(c.group_name, p.group_name) AS group_name,
        COALESCE(c.core_count, 0) AS core_count,
        COALESCE(p.peripheral_count, 0) AS peripheral_count
    FROM (
        SELECT
            group_name,
            COUNT(DISTINCT taxon_abbreviation) AS core_count
        FROM ApidbTuning.SequenceAttributes
        WHERE core_peripheral = 'C'
        GROUP BY group_name
    ) c
    FULL OUTER JOIN (
        SELECT
            group_name,
            COUNT(DISTINCT taxon_abbreviation) AS peripheral_count
        FROM ApidbTuning.SequenceAttributes
        WHERE core_peripheral = 'P'
        GROUP BY group_name
    ) p
    ON c.group_name = p.group_name
) subquery
WHERE
    core_count >= $$core_taxon_min$$
    AND core_count <= $$core_taxon_max$$
    AND peripheral_count >= $$peripheral_taxon_min$$
    AND peripheral_count <= $$peripheral_taxon_max$$
    AND (core_count + peripheral_count) >= $$all_taxon_min$$
    AND (core_count + peripheral_count) <= $$all_taxon_max$$
              ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ByPercentIdentity" isCacheable="true">
            <paramRef ref="groupParams.percent"/>
            <column name="group_name"/>
            <sql>
                <![CDATA[
    SELECT
        ogs.group_id AS group_name
    FROM
         apidb.orthologgroupstats AS ogs
    WHERE
        ogs.stat_type = 'median'
        AND ogs.evalue::numeric BETWEEN $$percent_min$$ AND $$percent_max$$
        AND ogs.protein_subset IN ('C+P', 'R')
                ]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="ByPhyleticPattern" isCacheable="true">
            <paramRef ref="groupParams.phyletic_expression"/>
            <column name="group_name"/>
            <sql>
                <![CDATA[
SELECT og.group_id AS group_name
FROM apidb.OrthologGroup og
WHERE og.group_id = ANY($$phyletic_expression$$)
                ]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="ByEcNumber" isCacheable="true">
            <paramRef ref="sharedParams.ec_number_type_ahead"/>
            <paramRef ref="groupParams.ec_wildcard"/>
            <column name="group_name"/>
            <sql>
                <![CDATA[
SELECT DISTINCT sec.group_name
FROM ApidbTuning.sequenceenzymeclass sec
WHERE (
    sec.ec_number LIKE REPLACE(REPLACE(lower($$ec_number_type_ahead$$), ' ', ''), '-', '%')
    OR
    sec.ec_number LIKE REPLACE(REPLACE(REPLACE(lower($$ec_wildcard$$), ' ', ''), '-', '%'), '*', '%')
    OR
    sec.description LIKE REPLACE($$ec_wildcard$$, '*', '%')
)
                 ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="FromSequences">
            <paramRef ref="sharedParams.sequence_answer"/>
            <column name="group_name"/>
            <column name="wdk_weight"/>
            <sql>
                <![CDATA[
SELECT sa.group_name, SUM(answer.wdk_weight) AS wdk_weight
FROM ApidbTuning.SequenceAttributes sa
JOIN ($$sequence_answer$$) answer ON sa.full_id = answer.full_id
GROUP BY sa.group_name
                ]]>
            </sql>
        </sqlQuery>

      <!-- Do not remove.  needed for Site Search tests -->
        <sqlQuery name="AllGroups" isCacheable="true">
            <column name="group_name"/>
            <sql>
                <![CDATA[
SELECT og.group_id AS group_name
FROM apidb.OrthologGroup og
              ]]>
            </sql>
        </sqlQuery>

    <!-- old Oracle text search, replaced by SOLR search below
    <processQuery name="ByTextSearch"
        processName="org.orthomcl.service.core.wsfplugin.KeywordSearchPlugin">

        <testParamValues>
            <paramValue name="text_expression">kinase</paramValue>
        </testParamValues>

       <paramRef ref="sharedParams.wdk_record_type" default="group"/>
       <paramRef ref="sharedParams.text_expression"/>
       <paramRef ref="groupParams.text_fields"/>
       <paramRef ref="sharedParams.detail_table" default="apidb.GroupDetail"/>
       <paramRef ref="sharedParams.primary_key_column" default="group_name"/>
       <paramRef ref="sharedParams.project_id" default="OrthoMCL"/>
       <wsColumn name="group_name" width="100" wsName="RecordID"/>
       <wsColumn name="project_id" width="20" wsName="ProjectId"/>
       <wsColumn name="max_score" width="10" wsName="MaxScore" columnType="float"/>
       <wsColumn name="fields_matched" width="64" wsName="Datasets"/>
    </processQuery>
    -->

    <processQuery name="ByTextSearch"
        processName="org.eupathdb.websvccommon.wsfplugin.solrsearch.EuPathSiteSearchPlugin">
      <paramRef ref="sharedParams.text_expression"/>
      <paramRef ref="sharedParams.document_type" default="group"/>
      <paramRef ref="sharedParams.text_fields"/>
      <wsColumn name="group_name" width="50"/>
      <wsColumn name="max_score" width="10" columnType="float"/>
    </processQuery>

  </querySet>

</wdkModel>
