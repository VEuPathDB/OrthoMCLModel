<?xml version="1.0" encoding="UTF-8"?>
<wdkModel>

    <!-- *************** -->
    <!-- model querySets -->
    <!-- *************** -->

    <!--
    A "query" obtains tabular values from a data source.  It has columns
    and parameters.  So far, only SQL data sources are supported, but others,
    such as flat files are coming.  

    Queries are used for different purposes: providing primary keys to a 
    question; providing attributes and tables to a record; and, providing
    vocabularies to vocabulary parameters.

    A "query set" is a grouping of queries.  It is useful in organizing the
    model xml file.  

    The full name of a query is of the form "set_name.name."
    -->


    <!-- Queries that return RNA primary keys (for use in questions and nested records.). -->

    <querySet name="SequenceIds" queryType="id" isCacheable="false">

      <sqlQuery name="ByIdList" isCacheable="true">
            <paramRef ref="sequenceParams.source_ids"/>
            <column name="full_id"/>
            <sql>
                <![CDATA[
SELECT aas.source_id AS full_id
FROM dots.aasequence aas
JOIN ($$source_ids$$) ds ON lower(aas.source_id) = lower(ds.full_id)
   OR lower(aas.source_id) = lower(ds.full_id)

UNION

SELECT aas.source_id AS full_id
FROM dots.aasequence aas
JOIN Dots.AaSequenceDbRef seqref ON aas.aa_sequence_id = seqref.aa_sequence_id
JOIN Sres.DbRef ref ON seqref.db_ref_id = ref.db_ref_id
JOIN Sres.ExternalDatabaseRelease dbr ON dbr.external_database_release_id = ref.external_database_release_id
JOIN Sres.ExternalDatabase db ON db.external_database_id = dbr.external_database_id
JOIN ($$source_ids$$) ds ON lower(ref.primary_identifier) = lower(ds.full_id)
   OR lower(ref.secondary_identifier) = lower(ds.full_id)
WHERE db.name = 'OrthoMCL Old Seqs'
				]]>
            </sql>
        </sqlQuery>  


        <sqlQuery name="ByAccession" isCacheable="true">
            <paramRef ref="sequenceParams.accession"/>
            <column name="full_id"/>
            <sql>
                <![CDATA[
SELECT sa.source_id as full_id
FROM ApidbTuning.SequenceAttributes sa
WHERE sa.source_id LIKE REPLACE($$accession$$, '*', '%')
   OR sa.full_id LIKE REPLACE($$accession$$, '*', '%')
   OR sa.group_name LIKE REPLACE($$accession$$, '*', '%')

UNION

SELECT sa.full_id
FROM Dots.AaSequenceDbRef seqref
JOIN Sres.DbRef ref ON seqref.db_ref_id = ref.db_ref_id
JOIN Sres.ExternalDatabaseRelease dbr ON dbr.external_database_release_id = ref.external_database_release_id
JOIN Sres.ExternalDatabase db ON db.external_database_id = dbr.external_database_id

JOIN ApidbTuning.SequenceAttributes sa ON sa.aa_sequence_id = seqref.aa_sequence_id
WHERE db.name IN ('OrthoMCL Old Groups', 'OrthoMCL Old Sequences')
  AND (ref.primary_identifier LIKE REPLACE($$accession$$, '*', '%')
       OR ref.secondary_identifier LIKE REPLACE($$accession$$, '*', '%'))
               ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ByKeyword" isCacheable="true">
            <paramRef ref="sharedParams.keyword"/>
            <column name="full_id"/>
            <sql>
                <![CDATA[
SELECT aas.source_id AS full_id
FROM dots.AaSequenceImp asi
JOIN dots.aasequence aas ON asi.aa_sequence_id = aas.aa_sequence_id
WHERE asi.subclass_view = 'ExternalAASequence'
  AND to_tsvector('english', asi.description) @@ to_tsquery($$keyword$$)
               ]]>
            </sql>
        </sqlQuery>


    <sqlQuery name="ByPFamIdOrKeyword" 
			isCacheable="true" doNotTest="true">

       <paramRef ref="sharedParams.pfam_id_type_ahead"/>
       <column name="full_id"/>

        <sql>
            <![CDATA[
SELECT DISTINCT full_id
FROM ApidbTuning.DomainAssignment
WHERE (accession LIKE UPPER(REPLACE($$pfam_id_type_ahead$$, '*', '%'))
       OR description LIKE REPLACE($$pfam_id_type_ahead$$, '*', '%'))
            ]]>
       </sql>
    </sqlQuery>


        <sqlQuery name="ByTaxonomy" isCacheable="true">
            <paramRef ref="sequenceParams.taxon_type_ahead"/>
            <column name="full_id"/>
            <sql>
                <![CDATA[
SELECT full_id 
FROM apidbtuning.sequenceattributes
WHERE taxon_abbreviation IN ($$taxon_type_ahead$$) 
               ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="ByEcNumber" isCacheable="true">
            <paramRef ref="sharedParams.ec_number_type_ahead"/>
            <column name="full_id"/>
            <sql>
                <![CDATA[
SELECT DISTINCT aas.source_id AS full_id
FROM dots.aasequence aas
JOIN apidb.orthologgroupaasequence ogas
  ON aas.aa_sequence_id = ogas.aa_sequence_id
JOIN dots.AaSequenceEnzymeClass asec
  ON aas.aa_sequence_id = asec.aa_sequence_id
JOIN sres.enzymeClass ec
  ON asec.enzyme_class_id = ec.enzyme_class_id
                 ]]>
            </sql>
        </sqlQuery>

	<!-- sequences that have at least one EC assignment -->
        <sqlQuery name="ByEcAssignment" isCacheable="true">
            <column name="full_id"/>
            <sql>
                <![CDATA[
SELECT DISTINCT aas.source_id AS full_id
FROM dots.aasequence aas
JOIN apidb.orthologgroupaasequence ogas
  ON aas.aa_sequence_id = ogas.aa_sequence_id
JOIN dots.AaSequenceEnzymeClass asec
  ON aas.aa_sequence_id = asec.aa_sequence_id
JOIN sres.enzymeClass ec
  ON asec.enzyme_class_id = ec.enzyme_class_id
                 ]]>
            </sql>
        </sqlQuery>



    <processQuery name="ByBlast"
             processName="org.orthomcl.service.core.wsfplugin.OrthoMCLBlastPlugin">

        <testParamValues>
            <paramValue name="BlastAlgorithm">blastp</paramValue>
            <paramValue name="BlastQuerySequence">ESEGARVGTPEGTDNNVRRPEEEKGREGERNGFLKSCALCLRGLGCAWCCQDFDAYELS</paramValue>
        </testParamValues>

       <paramRef ref="sequenceParams.BlastDatabase" />
       <paramRef ref="sequenceParams.BlastAlgorithm" />
       <paramRef ref="sequenceParams.BlastQuerySequence"/>
       <paramRef ref="sequenceParams.BlastRecordClass" default="SequenceRecordClasses.SequenceRecordClass" />
       <paramRef ref="sequenceParams.-e"/>
       <paramRef ref="sequenceParams.-b"/>
       <paramRef ref="sequenceParams.-filter" quote="false" />
       <wsColumn name="full_id" width="100" wsName="identifier"/>
       <wsColumn name="project_id" width="20" />
       <wsColumn name="evalue_mant" columnType="float" width="10"/>
       <wsColumn name="evalue_exp" columnType="number" width="5"/>  
       <wsColumn name="score" columnType="float" width="30"/>
       <wsColumn name="summary" width="3000"/>
       <wsColumn name="alignment" columnType="clob"/>       
    </processQuery>

    <!--
    <processQuery name="ByMultiBlast" 
             processName="org.apidb.apicomplexa.wsfplugin.blast.ProteinSequenceMultiBlastServicePlugin">

       <paramRef ref="multiBlastSequenceParams.MultiBlastDatabaseType" visible="false" quote="false" noTranslation="false"/>
       <paramRef ref="multiBlastSequenceParams.BlastAlgorithm" visible="false" quote="false" noTranslation="false" />
       <paramRef ref="sequenceParams.BlastQuerySequence"/>
       <paramRef ref="sequenceParams.BlastJobDescription"/>
       <paramRef groupRef="paramGroups.advancedParams" ref="sequenceParams.ExpectationValue"/>
       <paramRef groupRef="paramGroups.advancedParams" ref="sequenceParams.MaxTargetSeqs"/>
       <paramRef groupRef="paramGroups.advancedParams" ref="multiBlastSequenceParams.Sensitivity"/>
       <paramRef groupRef="paramGroups.advancedParams" ref="sequenceParams.Masking"/>
       <paramRef groupRef="paramGroups.advancedParams" ref="sequenceParams.CompBasedStats"/>
       <paramRef groupRef="paramGroups.advancedParams" ref="multiBlastSequenceParams.Iterate"/>

        <wsColumn name="full_id" width="50" wsName="identifier"/>
        <wsColumn name="project_id" width="20" />
        <wsColumn name="matched_result" width="1" wsName="matched_result"/>
        <wsColumn name="summary" width="3000"/>
        <wsColumn name="alignment" columnType="clob"/>
        <wsColumn name="evalue_mant" columnType="float" />
        <wsColumn name="evalue_exp" columnType="number" />
        <wsColumn name="score" columnType="float" />
      </processQuery>
    -->

      <processQuery name="MapProteinsByDiamond" 
        processName="org.apidb.apicomplexa.wsfplugin.blast.ProteinSequenceMultiBlastServicePlugin">

       <paramRef ref="multiBlastSequenceParams.BlastQuerySequence"/>
       <paramRef ref="sequenceParams.BlastJobDescription"/>

       <paramRef visible="false" ref="multiBlastSequenceParams.MultiBlastDatabaseType"/>
       <paramRef visible="false" ref="multiBlastSequenceParams.BlastAlgorithm" />
       <paramRef visible="false" ref="sequenceParams.ExpectationValue" default="0.05"/>
       <paramRef visible="false" ref="sequenceParams.MaxTargetSeqs" default="1"/>
       <paramRef visible="false" ref="multiBlastSequenceParams.ReportUnaligned"/>
       <paramRef visible="false" ref="multiBlastSequenceParams.Sensitivity"/>
       <paramRef visible="false" ref="multiBlastSequenceParams.Masking"/>
       <paramRef visible="false" ref="multiBlastSequenceParams.CompBasedStats"/>
       <paramRef visible="false" ref="multiBlastSequenceParams.Iterate"/>
       <paramRef visible="false" ref="multiBlastSequenceParams.DiamondOutputFields" />

        <wsColumn name="full_id" width="50" wsName="identifier"/>
        <wsColumn name="project_id" width="20" />
        <wsColumn name="matched_result" width="1" wsName="matched_result"/>
        <wsColumn name="summary" width="3000"/>
        <wsColumn name="alignment" columnType="clob"/>
        <wsColumn name="evalue_mant" columnType="float" />
        <wsColumn name="evalue_exp" columnType="number" />
        <wsColumn name="score" columnType="float" />
      </processQuery>

    <processQuery name="ByMotif"
                  processName="org.orthomcl.service.core.wsfplugin.MotifPlugin">
      <testParamValues>
        <paramValue name="motif_expression">CC6+RK</paramValue>
        <paramValue name="organism">pfal</paramValue>
      </testParamValues>

       <paramRef ref="sequenceParams.motif_expression" />
       <paramRef ref="sharedParams.organism" />
       <wsColumn name="full_id" width="100" />
       <wsColumn name="Locations" width="3999"/>
       <wsColumn name="MatchCount" width="10"/>
       <wsColumn name="Sequence" width="3999"/>
    </processQuery>


        <sqlQuery name="FromGroups" isCacheable="true">
            <paramRef ref="sharedParams.group_answer"/>
            <column name="full_id"/>
            <column name="wdk_weight"/>
            <sql>
              <![CDATA[
SELECT sa.full_id, MAX(ga.wdk_weight) AS wdk_weight
FROM ApidbTuning.SequenceAttributes sa
JOIN ($$group_answer$$) ga ON sa.group_name = ga.group_name
GROUP BY sa.full_id
              ]]>
           </sql>
        </sqlQuery>


      <!-- Do not remove.  needed for Site Search tests -->
        <sqlQuery name="AllSequences" isCacheable="true">
            <column name="full_id"/>
            <sql>
                <![CDATA[
SELECT aas.source_id AS full_id FROM dots.aasequence aas, apidbtuning.sequenceattributes sa
WHERE aas.taxon_id in (select distinct(aas.taxon_id) from apidb.organism og, dots.aasequence aas where aas.taxon_id = og.taxon_id)
AND aas.source_id = sa.full_id
               ]]>
            </sql>
        </sqlQuery>

    <!-- old Oracle text search, replaced by SOLR search below
    <processQuery name="ByTextSearch"
             processName="org.orthomcl.service.core.wsfplugin.KeywordSearchPlugin">

        <testParamValues>
            <paramValue name="text_expression">kinase</paramValue>
        </testParamValues>

       <paramRef ref="sharedParams.wdk_record_type" default="sequence"/>
       <paramRef ref="sharedParams.text_expression"/>
       <paramRef ref="sequenceParams.text_fields"/>
       <paramRef ref="sharedParams.detail_table" default="apidb.OrthomclSequenceDetail"/>
       <paramRef ref="sharedParams.primary_key_column" default="full_id"/>
       <paramRef ref="sharedParams.project_id" default="OrthoMCL"/>
       <wsColumn name="full_id" width="100" wsName="RecordID"/>
       <wsColumn name="project_id" width="20" wsName="ProjectId"/>
       <wsColumn name="max_score" width="10" wsName="MaxScore" columnType="float"/>
       <wsColumn name="fields_matched" width="64" wsName="Datasets"/>
    </processQuery>
    -->

    <processQuery name="ByTextSearch"
        processName="org.eupathdb.websvccommon.wsfplugin.solrsearch.EuPathSiteSearchPlugin">
      <paramRef ref="sharedParams.text_expression"/>
      <paramRef ref="sharedParams.document_type" default="sequence"/>
      <paramRef ref="sharedParams.text_fields"/>
      <wsColumn name="full_id" width="50"/>
      <wsColumn name="max_score" width="10" columnType="float"/>
    </processQuery>

    <sqlQuery name="BySharedOrtholog" isCacheable="true">
      <paramRef ref="sequenceParams.query_organism_type_ahead"/>
      <paramRef ref="sequenceParams.target_organism_type_ahead"/>
      <column name="full_id"/>
      <column name="group_name"/>
      <column name="target_id"/>
      <sql>
                <![CDATA[
SELECT 
    q.query AS full_id,
    q.group_id AS group_name,
    COALESCE(t.target, 'No Ortholog Found') AS target_id
FROM (
    SELECT 
        org1.source_id AS query,
        ogas.group_id
    FROM (
        SELECT aa_sequence_id, source_id
        FROM dots.aasequence
        WHERE taxon_id = $$query_organism_type_ahead$$
    ) org1
    LEFT JOIN apidb.orthologgroupaasequence ogas
        ON ogas.aa_sequence_id = org1.aa_sequence_id
) q
LEFT JOIN (
    SELECT 
        string_agg(org2.source_id, ',' ORDER BY org2.source_id) AS target,
        ogas.group_id
    FROM apidb.orthologgroupaasequence ogas
    INNER JOIN (
        SELECT aa_sequence_id, source_id
        FROM dots.aasequence
        WHERE taxon_id = $$target_organism_type_ahead$$
    ) org2
        ON ogas.aa_sequence_id = org2.aa_sequence_id
    GROUP BY ogas.group_id
) t
ON q.group_id = t.group_id
               ]]>
      </sql>
    </sqlQuery>
 
    <sqlQuery name="BySharedOrthologFromSequenceList" isCacheable="true">
      <paramRef ref="sequenceParams.querySequenceList"/>
      <paramRef ref="sequenceParams.target_organism_type_ahead"/>
      <column name="full_id"/>
      <column name="group_name"/>
      <column name="target_id"/>
      <sql>
                <![CDATA[
WITH query_proteins AS (
    -- Convert comma-separated string into an array
    SELECT aa_sequence_id, source_id
    FROM dots.aasequence
    WHERE source_id = ANY(string_to_array($$querySequenceList$$, ','))
),

q AS (
    -- Map each query protein to its ortholog group
    SELECT
        qp.source_id AS full_id,
        ogas.group_id
    FROM query_proteins qp
    LEFT JOIN apidb.orthologgroupaasequence ogas
        ON ogas.aa_sequence_id = qp.aa_sequence_id
),

t AS (
    -- Collect orthologs from the target taxon only
    SELECT
        ogas.group_id,
        string_agg(org2.source_id, ',' ORDER BY org2.source_id) AS target_id
    FROM apidb.orthologgroupaasequence ogas
    JOIN dots.aasequence org2
        ON org2.aa_sequence_id = ogas.aa_sequence_id
    WHERE org2.taxon_id = $$target_organism_type_ahead$$
    GROUP BY ogas.group_id
)

SELECT
    q.full_id,
    q.group_id AS group_name,
    COALESCE(t.target_id, 'No Ortholog Found') AS target_id
FROM q
LEFT JOIN t
    ON q.group_id = t.group_id
ORDER BY q.full_id
               ]]>
      </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
